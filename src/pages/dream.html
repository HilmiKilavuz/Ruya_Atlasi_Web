<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rüya Yorumlat - Rüya Atlası</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase Scripts -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>
    
    <!-- App Scripts -->
    <script type="module" src="../js/firebase-config.js"></script>
    <script type="module" src="../js/userService.js"></script>
    <style>
        :root {
            --primary-dark: #0d1642;
            --secondary-dark: #1a237e;
            --accent-gold: #ffd700;
            --text-cream: #f5f5f5;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2.5rem;
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Open Sans', sans-serif;
            --transition-normal: 0.3s;
        }
        body {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
            color: var(--text-cream);
            font-family: var(--font-body);
            min-height: 100vh;
            margin: 0;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 215, 0, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .floating-icons {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        .floating-icon {
            position: absolute;
            color: rgba(255, 215, 0, 0.1);
            font-size: 1.5rem;
            animation: float 15s infinite linear;
        }
        .floating-icon:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
        .floating-icon:nth-child(2) { top: 20%; left: 80%; animation-delay: -2s; }
        .floating-icon:nth-child(3) { top: 50%; left: 20%; animation-delay: -4s; }
        .floating-icon:nth-child(4) { top: 70%; left: 70%; animation-delay: -6s; }
        .floating-icon:nth-child(5) { top: 30%; left: 50%; animation-delay: -8s; }
        .floating-icon:nth-child(6) { top: 80%; left: 30%; animation-delay: -10s; }
        .floating-icon:nth-child(7) { top: 40%; left: 90%; animation-delay: -12s; }
        .floating-icon:nth-child(8) { top: 90%; left: 60%; animation-delay: -14s; }

        @keyframes float {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(50px, 50px) rotate(90deg);
            }
            50% {
                transform: translate(0, 100px) rotate(180deg);
            }
            75% {
                transform: translate(-50px, 50px) rotate(270deg);
            }
            100% {
                transform: translate(0, 0) rotate(360deg);
            }
        }
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(13, 22, 66, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .logo-container i {
            color: var(--accent-gold);
            font-size: 1.5rem;
        }

        .logo-text {
            color: var(--text-cream);
            font-family: var(--font-heading);
            font-size: 1.25rem;
            font-weight: 700;
        }

        .profile-section {
            position: relative;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .profile-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--accent-gold);
            color: #222;
            font-weight: 700;
            border-radius: 12px;
            border: 2px solid #fff;
            padding: 0.6rem 1.2rem 0.6rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s, border 0.2s;
            position: relative;
        }
        .profile-btn i {
            color: #222;
            font-size: 1.2rem;
        }
        .profile-btn .username {
            font-weight: 700;
            font-size: 1rem;
            color: #222;
        }
        .profile-btn .fa-chevron-down {
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }
        .profile-btn:focus, .profile-btn.active {
            outline: 2px solid var(--accent-gold);
            border: 2px solid var(--accent-gold);
        }
        .profile-dropdown {
            position: absolute;
            top: 110%;
            right: 0;
            background: #181c2f;
            border-radius: 12px;
            min-width: 210px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 0.5rem 0;
            z-index: 1000;
            display: none;
            border: 1.5px solid #23284d;
        }
        .profile-dropdown.active {
            display: block;
            animation: fadeIn 0.25s;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.85rem 1.3rem;
            color: var(--text-cream);
            text-decoration: none;
            font-size: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .dropdown-item i {
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
        }
        .dropdown-item:hover {
            background: #23284d;
            color: var(--accent-gold);
        }
        .dropdown-divider {
            height: 1px;
            background: #23284d;
            margin: 0.3rem 0;
        }
        .dropdown-item.logout {
            color: #ff4d4d;
        }
        .dropdown-item.logout i {
            color: #ff4d4d;
        }
        .dropdown-item.logout:hover {
            background: #23284d;
            color: #ff4d4d;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dream-center {
            padding-top: 5rem; /* Add space for fixed top bar */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }
        .dream-card {
            background: rgba(35, 40, 77, 0.95);
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.13);
            padding: var(--spacing-xl) var(--spacing-md);
            max-width: 420px;
            width: 100%;
            margin: var(--spacing-lg) 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        .dream-card h1 {
            font-family: var(--font-heading);
            color: var(--accent-gold);
            font-size: 2rem;
            margin: 0 0 var(--spacing-md) 0;
            text-align: center;
        }
        .dream-label {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--accent-gold);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .dream-textarea {
            width: 85%;
            height: 200px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.13);
            background: rgba(255,255,255,0.07);
            color: var(--text-cream);
            font-size: 1rem;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            transition: border var(--transition-normal);
            resize: none;
            margin-left: auto;
            margin-right: auto;
        }
        .dream-textarea:focus {
            outline: none;
            border: 1.5px solid var(--accent-gold);
        }
        .dream-btn {
            width: 100%;
            background: var(--accent-gold);
            color: var(--primary-dark);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
            padding: var(--spacing-md);
            cursor: pointer;
            transition: background var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        .dream-btn:hover {
            background: #ffe066;
        }
        .dream-result {
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: var(--spacing-lg) var(--spacing-md);
            margin-top: var(--spacing-md);
            color: var(--text-cream);
            font-size: 1.05rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            animation: fadeIn 0.7s;
        }
        .dream-result .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: rgba(255,215,0,0.13);
            color: var(--accent-gold);
            border-radius: 16px;
            font-size: 0.95rem;
            padding: 0.2rem 0.7rem;
            margin-bottom: var(--spacing-sm);
        }
        .dream-result-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            align-items: center;
        }
        .dream-result-actions .action-btn {
            background: none;
            border: none;
            color: var(--text-cream);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dream-result-actions .action-btn:hover {
            color: var(--accent-gold);
            background: rgba(255,255,255,0.1);
            transform: scale(1.1);
        }
        .dream-result-actions .favorite-btn {
            color: var(--text-cream);
        }
        .dream-result-actions .favorite-btn.active {
            color: var(--accent-gold);
        }
        .dream-result-actions .save-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--accent-gold);
            color: var(--primary-dark);
            font-weight: 600;
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .dream-result-actions .save-btn:hover {
            background: #ffe066;
            transform: translateY(-2px);
        }
        .dream-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            color: var(--accent-gold);
            font-weight: 600;
            margin-top: var(--spacing-md);
        }
        .dream-loading .fa-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 600px) {
            .dream-card { padding: var(--spacing-lg) var(--spacing-sm); }
            .dream-card h1 { font-size: 1.3rem; }
        }
    </style>
    
    <!-- Özel stil kuralları -->
    <style>
        /* Yıldız ikonunun sarı renk sorunu için kesin çözüm */
        .fas.fa-star {
            color: #ffd700 !important;
        }
        
        /* Favori buton stilleri */
        .favorite-btn {
            transition: transform 0.3s ease, color 0.3s ease;
        }
        
        .favorite-btn:hover {
            transform: scale(1.2);
        }
        
        .favorite-btn.active .fas.fa-star {
            color: #ffd700 !important;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            animation: pulse 1s;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Bildirim stilleri */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(35, 40, 77, 0.95);
            color: var(--text-cream);
            border-left: 4px solid var(--accent-gold);
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .notification i {
            color: var(--accent-gold);
            font-size: 1.2rem;
        }
        
        /* Rüya etiketleri stil */
        .dream-tag {
            display: inline-block;
            background: rgba(255, 215, 0, 0.15);
            color: var(--accent-gold);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            margin-right: 5px;
            margin-bottom: 5px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .dream-tag:hover {
            background: rgba(255, 215, 0, 0.25);
            transform: translateY(-2px);
        }

        /* Dropdown için eklenen stil */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--accent-gold);
            font-weight: 600;
        }
        
        .dream-select {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-cream);
            font-size: 1rem;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 16px;
        }
        
        .dream-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
        }
        
        .ai-note {
            margin-top: 1rem;
            padding: 0.75rem;
            border-left: 3px solid var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
            font-style: italic;
        }
        
        /* Yorum sonuçları için eklenen stiller */
        #dreamResult {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Yükleme göstergesi için geliştirilmiş stiller */
        .loading-interpretation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 1rem;
            color: var(--accent-gold);
            font-weight: 600;
            text-align: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 0 10px rgba(255, 215, 0, 0.1);
        }
        
        .loading-interpretation i {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }
        
        .loading-interpretation small {
            display: block;
            margin-top: 0.75rem;
            opacity: 0.8;
            font-weight: normal;
            font-style: italic;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .original-dream-container, 
        .interpretation-container {
            margin-bottom: 1.5rem;
        }
        
        .original-dream-container h3,
        .interpretation-container h3 {
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .original-dream,
        .interpretation {
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 10px;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        /* Hata durumu stilleri */
        .dream-result.error {
            padding: 1.5rem;
            background: rgba(255, 77, 77, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 77, 77, 0.3);
        }
        
        .dream-result.error h3 {
            color: #ff4d4d;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .dream-result.error i.fa-exclamation-triangle {
            color: #ff4d4d;
        }
        
        .error-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .error-actions ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            font-size: 0.95rem;
        }
        
        .error-actions li {
            margin-bottom: 0.4rem;
        }
        
        /* Sorun giderme bölümü için stil */
        .troubleshooting-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 193, 7, 0.08);
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 10px;
        }
        
        .troubleshooting-section h4 {
            color: rgba(255, 193, 7, 0.9);
            margin-bottom: 0.75rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .troubleshooting-section ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            font-size: 0.9rem;
        }
        
        .troubleshooting-section li {
            margin-bottom: 0.4rem;
        }
        
        .troubleshooting-section code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .retry-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.1rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-cream);
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }
        
        .retry-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="/index.html" class="logo-container">
            <i class="fas fa-moon"></i>
            <span class="logo-text">Rüya Atlası</span>
        </a>
        <div class="profile-section">
            <button class="profile-btn" id="profileToggle" tabindex="0">
                <i class="fas fa-user-circle"></i>
                <span class="username" id="profileUsername">19killme07</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="profile.html" class="dropdown-item"><i class="fas fa-user"></i>Profilim</a>
                <a href="dreams.html" class="dropdown-item"><i class="fas fa-book"></i>Rüyalarım</a>
                <a href="favorites.html" class="dropdown-item"><i class="fas fa-star"></i>Favorilerim</a>
                <a href="profile.html#personal-info" class="dropdown-item"><i class="fas fa-cog"></i>Ayarlar</a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item logout" id="logoutBtn"><i class="fas fa-sign-out-alt"></i>Çıkış Yap</a>
            </div>
        </div>
    </div>
    <div class="floating-icons">
        <i class="fas fa-moon floating-icon"></i>
        <i class="fas fa-star floating-icon"></i>
        <i class="fas fa-cloud-moon floating-icon"></i>
        <i class="fas fa-magic floating-icon"></i>
        <i class="fas fa-sparkles floating-icon"></i>
        <i class="fas fa-crystal-ball floating-icon"></i>
        <i class="fas fa-wand-magic-sparkles floating-icon"></i>
        <i class="fas fa-feather-alt floating-icon"></i>
    </div>
    <div class="dream-center">
        <form class="dream-card" id="dreamForm" autocomplete="off">
            <h1><i class="fas fa-moon"></i> Rüya Yorumlat</h1>
            <div class="form-group">
                <label for="interpreter">Yorumlama Yaklaşımı:</label>
                <select id="interpreter" name="interpreter" class="dream-select">
                    <option value="1">Sigmund Freud</option>
                    <option value="2">Carl Jung</option>
                    <option value="3">Alfred Adler</option>
                    <option value="4">Erich Fromm</option>
                </select>
            </div>
            <label for="dreamText" class="dream-label"><i class="fas fa-feather-alt"></i> Rüyanızı Yazın</label>
            <textarea id="dreamText" class="dream-textarea" placeholder="Rüyanızı detaylıca yazın..."></textarea>
            <button type="submit" class="dream-btn" id="interpretBtn">
                <i class="fas fa-magic"></i> Yorumla
            </button>
            <div id="dreamResult">
                <!-- Rüya yorumu burada gösterilecek -->
                <div class="loading-interpretation" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Rüyanız yapay zeka tarafından yorumlanıyor...<br><small>(Bu işlem 30 saniye kadar sürebilir)</small>
                </div>
            </div>
        </form>
    </div>
    <script type="module">
        import { auth, db } from '../js/firebase-config.js';
        import { onAuthStateChanged } from 'firebase/auth';
        import { doc, getDoc } from 'firebase/firestore';
        import { saveDream, toggleFavorite } from '../js/dream-service.js';
        
        console.log('Firebase modülleri yüklendi, auth:', auth);
        console.log('Firestore db objesi:', db);
        
        const usernameSpan = document.getElementById('profileUsername');
        
        onAuthStateChanged(auth, async (user) => {
            if (user && usernameSpan) {
                console.log("Kullanıcı oturum açtı:", user);
                
                // Önce Firestore'dan kullanıcı profilini al
                try {
                    console.log('Firestore doc çağrısı yapılıyor...');
                    const userDocRef = doc(db, 'users', user.uid);
                    console.log('Firestore doc referansı oluşturuldu:', userDocRef);
                    
                    console.log('getDoc çağrısı yapılıyor...');
                    const userSnapshot = await getDoc(userDocRef);
                    console.log('Firestore döküman snapshot alındı:', userSnapshot);
                    
                    if (userSnapshot.exists() && userSnapshot.data().username) {
                        // Firestore'da kayıtlı username varsa onu kullan
                        usernameSpan.textContent = userSnapshot.data().username;
                        console.log("Kullanıcı adı Firestore'dan alındı:", userSnapshot.data().username);
                    } else {
                        // Yoksa auth'taki displayName veya email'i kullan
                        usernameSpan.textContent = user.displayName || (user.email ? user.email.split('@')[0] : 'Kullanıcı');
                        console.log("Kullanıcı adı Auth'tan alındı:", usernameSpan.textContent);
                    }
                } catch (error) {
                    console.error("Kullanıcı profili alınamadı:", error);
                    console.error("Hata detayları:", JSON.stringify(error));
                    // Hata durumunda auth'taki bilgiyi kullan
                    usernameSpan.textContent = user.displayName || (user.email ? user.email.split('@')[0] : 'Kullanıcı');
                }
            } else if(usernameSpan) {
                usernameSpan.textContent = 'Kullanıcı';
            }
        });
    </script>
    <script type="module">
        import { auth } from '../js/firebase-config.js';
        import { saveDream, toggleFavorite } from '../js/dream-service.js';
        
        const form = document.getElementById('dreamForm');
        const textarea = document.getElementById('dreamText');
        const resultDiv = document.getElementById('dreamResult');
        const btn = document.getElementById('interpretBtn');
        const interpreterSelect = document.getElementById('interpreter');
        
        // API URL - Ahmet'in bilgisayarındaki Flask API
        const API_URL = "http://192.168.254.150:5000/yorumla";  // Güncellenmiş IP Adresi
        
        // Yerel yorumlama fonksiyonu (API erişilemediğinde)
        function getLocalInterpretation(dream, interpreter) {
            // Rüyadaki bazı anahtar kelimeleri tespit etmeye çalış
            const dreamLower = dream.toLowerCase();
            
            let interpretation = "";
            let tags = ['Bilinçaltı', 'Semboller'];
            
            // Seçilen yorumcuya göre genel yorumlama yaklaşımı
            switch(interpreter) {
                case "1": // Freud
                    interpretation = "Freud'un psikanalitik yaklaşımına göre, rüyalarınız bilinçaltınızdaki bastırılmış dürtüleri ve arzuları temsil edebilir. Bu rüya, günlük hayatınızda ifade edemediğiniz duygu ve düşüncelerin bir yansıması olabilir. Bilinçaltınızdaki çatışmaları anlamak için, rüyanızda bulunan sembollerin sizin için kişisel anlamını düşünmeniz faydalı olacaktır.";
                    tags.push('Psikanaliz');
                    break;
                    
                case "2": // Jung
                    interpretation = "Jung'un analitik psikoloji yaklaşımına göre, bu rüya kolektif bilinçdışınızdaki arketipsel sembolleri içerebilir. Rüyanız kişisel gelişim sürecinizde bir dönüm noktasını veya içsel bir dönüşümü simgeliyor olabilir. Bireyselleşme yolculuğunuzda size rehberlik eden önemli ipuçları barındırıyor.";
                    tags.push('Arketipler');
                    break;
                    
                case "3": // Adler
                    interpretation = "Adler'in bireysel psikoloji anlayışına göre, rüyanız yaşam tarzınızı ve sosyal ilişkilerinizdeki hedeflerinizi yansıtıyor olabilir. Bu rüya, toplum içindeki yeriniz, aidiyet duygunuz ve yetersizlik hislerinizle nasıl başa çıktığınızla ilgili ipuçları veriyor. Yaşamınızda üstesinden gelmeye çalıştığınız zorluklar ve bu konudaki motivasyonunuz rüyada kendini gösteriyor.";
                    tags.push('Sosyal İlişkiler');
                    break;
                    
                case "4": // Fromm
                    interpretation = "Fromm'un hümanistik yaklaşımına göre, bu rüya modern toplumda bireysel özgürlüğünüz ve kimliğinizle ilgili endişelerinizi yansıtabilir. Rüyanızda toplumsal normlardan bağımsızlaşma ve kendinizi gerçekleştirme arzunuz görülüyor. Rüyanız, sevgi ve üretkenlik arayışınızın bir ifadesi olarak değerlendirilebilir.";
                    tags.push('Özgürlük & Kimlik');
                    break;
                    
                default:
                    interpretation = "Rüyalar, bilinçaltımızın bir yansımasıdır ve genellikle günlük yaşantımızdaki olaylar ve duygularla bağlantılıdır. Bu rüya, hayatınızda yaşadığınız değişimleri veya duygusal durumunuzu yansıtıyor olabilir. Rüyanızı kendi yaşam bağlamınız içinde değerlendirmeniz en sağlıklı yaklaşım olacaktır.";
            }
            
            // Rüya içeriğine göre bazı özel yorumlar ekle
            if (dreamLower.includes("uçmak") || dreamLower.includes("uçuyorum")) {
                interpretation += " Rüyanızda uçma deneyimi, özgürlük arzunuzu veya mevcut durumunuzdan uzaklaşma isteğinizi sembolize edebilir. Hayatınızda daha fazla özgürlük ve kontrol arayışında olabilirsiniz.";
                tags.push('Özgürlük');
            } else if (dreamLower.includes("düşmek") || dreamLower.includes("düşüyorum")) {
                interpretation += " Düşme hissi, hayatınızda kontrol edemediğiniz durumlar veya kaygılar yaşadığınızı gösterebilir. Belki de bir konuda güvensizlik hissediyorsunuz veya başarısızlık korkusu yaşıyorsunuz.";
                tags.push('Kaygı');
            } else if (dreamLower.includes("su") || dreamLower.includes("deniz") || dreamLower.includes("okyanus")) {
                interpretation += " Su unsurları bilinçaltınızın derinliklerini ve duygusal durumunuzu temsil eder. Suyun durumu (sakin/dalgalı) duygusal durumunuzla ilgili ipuçları verebilir.";
                tags.push('Duygular');
            } else if (dreamLower.includes("kaçmak") || dreamLower.includes("kovalamak")) {
                interpretation += " Kaçma veya kovalanma temalı rüyalar genellikle hayatınızda kaçındığınız sorunları veya duygularınızı gösterebilir. Yüzleşmekten çekindiğiniz bir durumla ilgili olabilir.";
                tags.push('Kaçınma');
            }
            
            return {
                interpretation: interpretation,
                tags: tags
            };
        }
        
        // Kaydedilen rüya verileri
        let currentDreamData = null;
        let savedDreamId = null;
        let isFavorite = false; // Varsayılan olarak favori değil

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const dream = textarea.value.trim();
            if (!dream) {
                resultDiv.innerHTML = '<div class=\"dream-result\" style=\"color:#ffd700;background:none;\">Lütfen rüyanızı yazın.</div>';
                return;
            }
            
            btn.disabled = true;
            const loadingDiv = resultDiv.querySelector('.loading-interpretation');
            loadingDiv.style.display = 'block';
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rüyanız yapay zeka tarafından yorumlanıyor...<br><small>(Bu işlem 30 saniye kadar sürebilir)</small>';
            
            // Seçilen yorumcu (default: Freud)
            const selectedInterpreter = interpreterSelect ? interpreterSelect.value : "1";
            const interpreterNames = {
                "1": "Sigmund Freud",
                "2": "Carl Jung",
                "3": "Alfred Adler", 
                "4": "Erich Fromm"
            };
            const interpreterName = interpreterNames[selectedInterpreter];
            
            try {
                console.log("API'ye istek gönderiliyor:", API_URL);
                
                let interpretation = "";
                let note = "";
                let tags = ['Bilinçaltı', 'Semboller', 'Kişisel Gelişim'];
                let useLocalInterpretation = false;
                
                try {
                    // API isteği için timeout kontrolü ekliyoruz
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        console.log("API isteği zaman aşımına uğradı!");
                        controller.abort();
                    }, 30000); // 30 saniye timeout (15 saniyeden artırıldı)
                    
                    console.log("API isteği gönderiliyor...", API_URL);
                    
                    // Ahmet'in bilgisayarındaki API'ye istek gönder
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            ruya: dream,
                            secim: selectedInterpreter,
                            dil: "tr"
                        }),
                        signal: controller.signal
                    }).catch(err => {
                        console.error("Fetch hatası:", err);
                        throw err;
                    });
                    
                    // Timeout'u temizle
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP hata: ${response.status}`);
                    }
                    
                    // API'den gelen yanıtı al
                    const result = await response.json();
                    console.log("API yanıtı:", result);
                    
                    if (result.error) {
                        throw new Error(`API hatası: ${result.error}`);
                    }
                    
                    // Yapay zeka yorumunu al
                    interpretation = result.interpretation || "Üzgünüz, rüyanız yorumlanamadı.";
                    note = result.note || "";
                    
                } catch (apiError) {
                    // API hatası durumunda yerel yorumlama kullan
                    console.error("API hatası:", apiError.message, apiError);
                    useLocalInterpretation = true;
                    
                    // Hata türüne göre özel mesaj
                    let errorDetail = "";
                    if (apiError.name === "AbortError") {
                        errorDetail = "Zaman aşımı - API sunucusu yanıt vermedi (30 saniye içinde).";
                    } else if (apiError.message.includes("fetch") || apiError.message.includes("Failed to fetch")) {
                        errorDetail = "Bağlantı hatası - API sunucusuna erişilemiyor (ağ bağlantınızı kontrol edin).";
                    } else if (apiError.message.includes("aborted")) {
                        errorDetail = "İstek iptal edildi - API sunucusu yanıt vermedi veya bağlantı koptu.";
                    } else {
                        errorDetail = apiError.message;
                    }
                    
                    console.log("Yerel yorumlama kullanılıyor. Hata detayı:", errorDetail);
                    
                    // Yerel yorumlama kullan
                    const localResult = getLocalInterpretation(dream, selectedInterpreter);
                    interpretation = localResult.interpretation;
                    tags = localResult.tags;
                    note = `⚠️ API sunucusuna bağlanılamadı (${errorDetail}). Bu yorum yerel olarak oluşturulmuştur.`;
                }
                
                // Rüya verilerini oluştur
                currentDreamData = {
                    content: dream,
                    interpretation: interpretation,
                    tags: tags,
                    date: new Date().toISOString(),
                    isFavorite: false
                };
                
                // Sonuç bölümünü göster
                loadingDiv.style.display = 'none';
                resultDiv.innerHTML = `
                    <div class="dream-result">
                        <div class="ai-badge"><i class="fas fa-brain"></i> ${interpreterName} Yaklaşımı</div>
                        <div class="original-dream-container">
                            <h3>Rüyanız:</h3>
                            <p class="original-dream">${dream}</p>
                        </div>
                        <div class="interpretation-container">
                            <h3>Yorum:</h3>
                            <p class="interpretation">${interpretation}</p>
                        </div>
                        ${note ? `<div class="ai-note"><i class="fas fa-info-circle"></i> ${note}</div>` : ''}
                        <div class="tags-container">
                            ${tags.map(tag => `<span class="dream-tag">${tag}</span>`).join('')}
                        </div>
                        
                        ${useLocalInterpretation ? `
                        <div class="troubleshooting-section">
                            <h4><i class="fas fa-wrench"></i> Bağlantı Sorunları Giderme</h4>
                            <ol>
                                <li>Ahmet'in bilgisayarının açık olduğundan emin olun.</li>
                                <li>Flask API'nin Ahmet'in bilgisayarında çalıştığını doğrulayın.</li>
                                <li>Aynı ağda olduğunuzdan emin olun (aynı Wi-Fi'ye bağlı olmalısınız).</li>
                                <li>Güvenlik duvarı veya antivirüs yazılımı bağlantıyı engelliyor olabilir.</li>
                                <li>Flask uygulamasında CORS ayarlarının düzgün yapılandırıldığını kontrol edin.</li>
                                <li>API IP adresi: <code>192.168.254.150</code> doğru olduğundan emin olun.</li>
                            </ol>
                        </div>
                        ` : ''}
                        
                        <div class="dream-result-actions">
                            <button class="action-btn favorite-btn ${isFavorite ? 'active' : ''}" id="favoriteBtn" title="${isFavorite ? 'Favorilerden çıkar' : 'Favorilere ekle'}">
                                <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>
                            </button>
                            <button class="save-btn" id="saveBtn">
                                <i class="fas fa-save"></i> Kaydet
                            </button>
                        </div>
                    </div>
                `;
                
                // Butonlara olay dinleyicileri ekle
                const favoriteBtn = document.getElementById('favoriteBtn');
                const saveBtn = document.getElementById('saveBtn');
                
                favoriteBtn.addEventListener('click', handleFavoriteToggle);
                saveBtn.addEventListener('click', handleSaveDream);
                
            } catch (error) {
                console.error('Rüya yorumlama hatası:', error);
                loadingDiv.style.display = 'none';
                resultDiv.innerHTML = `
                    <div class="dream-result error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Hata</h3>
                        <p>${error.message}</p>
                        <div class="error-actions">
                            <p>Lütfen şunları kontrol edin:</p>
                            <ul>
                                <li>Internet bağlantınız aktif mi?</li>
                                <li>Ahmet'in bilgisayarı açık ve API çalışıyor mu?</li>
                                <li>Aynı ağa bağlı mısınız?</li>
                            </ul>
                            <button onclick="window.location.reload()" class="retry-btn">
                                <i class="fas fa-redo"></i> Tekrar Dene
                            </button>
                        </div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
            }
        });
        
        // Favorilere ekleme/çıkarma işlevi
        async function handleFavoriteToggle() {
            const favoriteBtn = document.getElementById('favoriteBtn');
            isFavorite = !isFavorite;
            
            if (isFavorite) {
                favoriteBtn.innerHTML = '<i class="fas fa-star"></i>';
                favoriteBtn.classList.add('active');
            } else {
                favoriteBtn.innerHTML = '<i class="far fa-star"></i>';
                favoriteBtn.classList.remove('active');
            }
            
            // Kullanıcının oturum açtığından emin ol
            if (!auth.currentUser) {
                console.error('Kullanıcı oturum açmamış');
                alert('Favorilere eklemek için giriş yapmalısınız.');
                return;
            }
            
            // Eğer rüya zaten kaydedilmişse, favori durumunu güncelle
            if (savedDreamId) {
                try {
                    const result = await toggleFavorite(savedDreamId, isFavorite);
                    if (result.success) {
                        console.log(`Rüya favorilere ${isFavorite ? 'eklendi' : 'çıkarıldı'}`);
                        
                        // Başarılı işlem bildirimi göster
                        const message = isFavorite ? 'Rüya favorilere eklendi!' : 'Rüya favorilerden çıkarıldı!';
                        const notificationDiv = document.createElement('div');
                        notificationDiv.className = 'notification';
                        notificationDiv.innerHTML = `<i class="fas ${isFavorite ? 'fa-star' : 'fa-check'}"></i> ${message}`;
                        document.body.appendChild(notificationDiv);
                        
                        setTimeout(() => {
                            notificationDiv.style.opacity = '0';
                            setTimeout(() => {
                                document.body.removeChild(notificationDiv);
                            }, 500);
                        }, 2000);
                        
                        // Kaydedilen rüya verisini güncelle
                        currentDreamData.isFavorite = isFavorite;
                    } else {
                        throw new Error(result.error || 'Favori durumu güncellenemedi');
                    }
                } catch (error) {
                    console.error('Favori durumu güncellenirken hata:', error);
                    alert('Favori durumu güncellenirken bir hata oluştu. Lütfen tekrar deneyin.');
                }
            } else {
                // Henüz kaydedilmemiş, önce rüyayı kaydet
                try {
                    currentDreamData.isFavorite = isFavorite;
                    const result = await saveDream(auth.currentUser.uid, currentDreamData);
                    
                    if (result.success) {
                        savedDreamId = result.dreamId;
                        console.log('Rüya kaydedildi ve favorilere eklendi. ID:', savedDreamId);
                        
                        // Başarılı işlem bildirimi göster
                        const notificationDiv = document.createElement('div');
                        notificationDiv.className = 'notification';
                        notificationDiv.innerHTML = `<i class="fas fa-star"></i> Rüya favorilere eklendi!`;
                        document.body.appendChild(notificationDiv);
                        
                        setTimeout(() => {
                            notificationDiv.style.opacity = '0';
                            setTimeout(() => {
                                document.body.removeChild(notificationDiv);
                            }, 500);
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'Rüya kaydedilemedi');
                    }
                } catch (error) {
                    console.error('Rüya kaydedilirken hata:', error);
                    alert('Rüya kaydedilirken bir hata oluştu. Lütfen tekrar deneyin.');
                    // Hata durumunda favori durumunu geri al
                    isFavorite = !isFavorite;
                    favoriteBtn.innerHTML = isFavorite ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
                    favoriteBtn.classList.toggle('active', isFavorite);
                }
            }
        }
        
        // Rüyayı kaydetme işlevi
        async function handleSaveDream() {
            const saveBtn = document.getElementById('saveBtn');
            
            // Kullanıcının oturum açtığından emin ol
            if (!auth.currentUser) {
                console.error('Kullanıcı oturum açmamış');
                return;
            }
            
            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
                
                // Eğer rüya daha önce kaydedilmediyse
                if (!savedDreamId) {
                    const result = await saveDream(auth.currentUser.uid, currentDreamData);
                    
                    if (result.success) {
                        savedDreamId = result.dreamId;
                        console.log('Rüya başarıyla kaydedildi. ID:', savedDreamId);
                        
                        saveBtn.innerHTML = '<i class="fas fa-check"></i> Kaydedildi';
                        setTimeout(() => {
                            saveBtn.innerHTML = '<i class="fas fa-save"></i> Kaydet';
                            saveBtn.disabled = false;
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'Kaydetme işlemi başarısız');
                    }
                } else {
                    // Rüya zaten kaydedilmiş, güncelleme mesajı göster
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> Zaten Kaydedildi';
                    setTimeout(() => {
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> Kaydet';
                        saveBtn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Rüya kaydedilirken hata:', error);
                saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Hata';
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Tekrar Dene';
                    saveBtn.disabled = false;
                }, 2000);
            }
        }

        // Profile dropdown functionality
        const profileToggle = document.getElementById('profileToggle');
        const profileDropdown = document.getElementById('profileDropdown');
        profileToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('active');
            profileToggle.classList.toggle('active');
        });
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!profileToggle.contains(e.target) && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.remove('active');
                profileToggle.classList.remove('active');
            }
        });
        // Keyboard accessibility
        profileToggle.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                profileDropdown.classList.toggle('active');
                profileToggle.classList.toggle('active');
            }
        });
        // Logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                // Firebase authentication'dan çıkış yap
                const { logout } = await import('../js/userService.js');
                await logout();
                console.log('Başarıyla çıkış yapıldı');
                // Çıkış sonrası login sayfasına yönlendir
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Çıkış yapılırken hata oluştu:', error);
            }
        });
    </script>
    <script type="module">
        import { auth } from '../js/firebase-config.js';
        import { onAuthStateChanged } from 'firebase/auth';
        
        // Korumalı sayfa kontrolü
        function checkAuth() {
            onAuthStateChanged(auth, user => {
                if (!user) {
                    console.log('Rüya yorumlama sayfası için yetkilendirme gerekli.');
                    window.location.href = '/src/pages/signup.html';
                } else {
                    console.log('Kullanıcı oturum açmış. Erişim izni verildi.');
                }
            });
        }
        
        // Sayfa yüklendiğinde auth kontrolünü çalıştır
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>